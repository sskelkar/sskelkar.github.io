

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>Squashing ruby on rails database migrations - </title>

  <meta name="description" content="Why do it?
There are several reasons why you&rsquo;d want to squash the database migrations in your Ruby on Rails application:


In a long running project you may end up with hundreds of files in your db/migrate folder over time. Carrying these legacy
migrations incurs maintenance overhead. For example, when upgrading the Rails version, you may need to modify those old migrations for
syntax changes.


If your build process involves recreating the database to run the tests, it would need to run all of these old migrations. Running a lot
of migrations would slow down the build time."><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Sojjwal Kelkar",
    
    "url": "https:\/\/sskelkar.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/sskelkar.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/sskelkar.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/sskelkar.github.io\/post\/squashing-ruby-on-rails-database-migrations\/",
          "name": "Squashing ruby on rails database migrations"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Sojjwal Kelkar"
  },
  "headline": "Squashing ruby on rails database migrations",
  "description" : "Why do it? There are several reasons why you\u0026rsquo;d want to squash the database migrations in your Ruby on Rails application:\nIn a long running project you may end up with hundreds of files in your db\/migrate folder over time. Carrying these legacy migrations incurs maintenance overhead. For example, when upgrading the Rails version, you may need to modify those old migrations for syntax changes.\nIf your build process involves recreating the database to run the tests, it would need to run all of these old migrations. Running a lot of migrations would slow down the build time.\n",
  "inLanguage" : "en",
  "wordCount":  671 ,
  "datePublished" : "2021-02-13T00:00:00\u002b01:00",
  "dateModified" : "2021-02-13T00:00:00\u002b01:00",
  "image" : "https:\/\/sskelkar.github.io\/",
  "keywords" : [ "Ruby on Rails" ],
  "mainEntityOfPage" : "https:\/\/sskelkar.github.io\/post\/squashing-ruby-on-rails-database-migrations\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/sskelkar.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/sskelkar.github.io\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Squashing ruby on rails database migrations" />
<meta property="og:description" content="Why do it?
There are several reasons why you&rsquo;d want to squash the database migrations in your Ruby on Rails application:


In a long running project you may end up with hundreds of files in your db/migrate folder over time. Carrying these legacy
migrations incurs maintenance overhead. For example, when upgrading the Rails version, you may need to modify those old migrations for
syntax changes.


If your build process involves recreating the database to run the tests, it would need to run all of these old migrations. Running a lot
of migrations would slow down the build time.">
<meta property="og:url" content="https://sskelkar.github.io/post/squashing-ruby-on-rails-database-migrations/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Sojjwal Kelkar" />

  <meta name="twitter:title" content="Squashing ruby on rails database migrations" />
  <meta name="twitter:description" content="Why do it?
There are several reasons why you&rsquo;d want to squash the database migrations in your Ruby on Rails application:


In a long running project you may end up with hundreds of files in your â€¦">
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="generator" content="Hugo 0.148.2">
  <link rel="alternate" href="https://sskelkar.github.io/index.xml" type="application/rss+xml" title="Sojjwal Kelkar"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css" integrity="sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="https://sskelkar.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://sskelkar.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://sskelkar.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://sskelkar.github.io/">Sojjwal Kelkar</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Tech Blog" href="/">Tech Blog</a>
            </li>
          
        
          
            <li>
              <a title="Cartoons" href="/cartoons">Cartoons</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/about">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>













<header class="header-section ">
  
  <div class="intro-header no-img">
    
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          <div class="post-heading">
            <h1>Squashing ruby on rails database migrations</h1>
            <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on Feb 13, 2021
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
  
  
  
  
</span>


          </div>
        </div>
      </div>
    </div>
    
  </div>
</header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <h2 id="why-do-it">Why do it?</h2>
<p>There are several reasons why you&rsquo;d want to squash the database migrations in your Ruby on Rails application:</p>
<ol>
<li>
<p>In a long running project you may end up with hundreds of files in your <code>db/migrate</code> folder over time. Carrying these legacy
migrations incurs maintenance overhead. For example, when upgrading the Rails version, you may need to modify those old migrations for
syntax changes.</p>
</li>
<li>
<p>If your build process involves recreating the database to run the tests, it would need to run all of these old migrations. Running a lot
of migrations would slow down the build time.</p>
</li>
<li>
<p>The migration file names need to be in the format <code>YYYYMMDDHHMMSS_add_quantity_to_orders.rb</code>. The timestamp is used to determine
the order in which the migrations are applied. Rails provides a generator
to create such migration files automatically. But sometimes developers may create these files manually. If they make a mistake
in the timestamp and commit the migration, it would mess up the ordering. For example, someone may accidentally add an extra digit in the timestamp and the migration
may get applied on production. Then all subsequent migrations
should also contain the extra digit to maintain the order of the migrations. In such a case it is better to squash the migrations and start over.</p>
</li>
<li>
<p>The previous point also applies to any problems due to not following the best practices while creating migrations (eg. incorrectly using
a model class in the migration). In all of such cases, we can squash the migrations and get a clean slate.</p>
</li>
</ol>
<h2 id="what-to-do">What to do?</h2>
<p>The purpose of migrations is to incrementally evolve an existing database. When setting up a new environment, they can create
a new database with the desired schema and settings suitable for our application.</p>
<p>The squashed migration is just a regular migration that replaces the existing migrations and becomes the starting point
going forward. Just like any other
migration, it is a subclass of <code>ActiveRecord::Migration</code> and follows the same naming convention.</p>
<p>There are two important things to consider when creating the squashed migration:</p>
<ol>
<li>
<p>On running the squashed migration in a new database, it should end up with the table structure and settings identical to other
existing databases.</p>
</li>
<li>
<p>You would need to run the squashed migration on the existing databases as well. Doing this on an existing
database should have absolutely no effect. For example, the squashed migration should not accidentally recreate a production table.</p>
</li>
</ol>
<h2 id="how-to-do-it">How to do it?</h2>
<p>Rails maintains a schema file (located in <code>db/schema.rb</code>) that represents the current state of the database. Every time a migration runs,
this file gets automatically updated to incorporate the changes introduced by that migration.</p>
<ol>
<li>
<p>When creating the squashed migration, the first step could be to copy the contents of the schema file into its <code>up</code> or <code>change</code> method.</p>
</li>
<li>
<p>Remember, this migration should not change anything if applied on an existing database. Therefore from each <code>create_table</code> statement,
remove the <code>force</code> flag and add a <code>table_exists?</code> check to ensure that it won&rsquo;t try to recreate a table if it already exists.</p>
</li>
<li>
<p>This also applies to any other database objects like enums, the table definitions may depend on. If Rails does not provide an &rsquo;exists?&rsquo; method
for these objects, you may need to run plain SQL queries like this:</p>
</li>
</ol>
<pre tabindex="0"><code>ActiveRecord::Base.connection.execute(&#34;select 1 from pg_type where typname = &#39;#{enum_type_name}&#39;&#34;).first.present?
</code></pre><ol start="4">
<li>
<p>Similarly add checks on all <code>add_foreign_key</code> statements to ensure they are only created if they don&rsquo;t exist. Rails provides a
<code>foreign_key_exists?</code> method that can be used here.</p>
</li>
<li>
<p>While the schema file contains most of the information about the database schema, it does not capture everything. It does not support
several features that may be provided by the database such as triggers, sequences, stored procedures etc. If the database is Postgres,
schema file does not capture table level settings such as autovacuum_vacuum_scale_factor. It also lacks any information about
table partitioning.</p>
</li>
</ol>
<p>Due to this limitation, it is strongly recommended that you must scan through all of the old migration files to look for these features or settings.
You&rsquo;d need to explicitly add them in your squashed migration.</p>


        
          <div class="blog-tags">
            
              
              <a href="https://sskelkar.github.io/tags/ruby-on-rails/">Ruby on Rails</a>&nbsp;
            
          </div>
        

        

        
          

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://sskelkar.github.io/post/postgres-explain-analyze/" data-toggle="tooltip" data-placement="top" title="Understanding a Postgres query plan">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://sskelkar.github.io/post/software-tenbagger/" data-toggle="tooltip" data-placement="top" title="Software tenbagger">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
      
      
      
      
        
      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            2025
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://sskelkar.github.io/">Sojjwal Kelkar</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          &bull;&nbsp;Powered by Hugo&nbsp;&bull;&nbsp;
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://sskelkar.github.io/js/main.js"></script>
<script src="https://sskelkar.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://sskelkar.github.io/js/load-photoswipe.js"></script>










    
  </body>
</html>

